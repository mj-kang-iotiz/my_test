name: C/C++ CI

on:
  push:
    branches: [ '**' ]
    # ë¬´í•œ ë£¨í”„ ë°©ì§€: GitHub Actionsê°€ ë§Œë“  ì»¤ë°‹ì€ ë¬´ì‹œ
    paths-ignore:
      - '.github/workflows/**'
  pull_request:
    branches: [ '**' ]

env:
  BUILD_TYPE: Release

jobs:
  # ìžë™ ì½”ë“œ í¬ë§·íŒ… (push í•  ë•Œë§ˆë‹¤ ë™ìž‘)
  auto-format:
    if: github.event_name == 'push' && !contains(github.event.head_commit.message, '[skip-format]') && !contains(github.event.head_commit.message, 'ðŸŽ¨')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0  # ì „ì²´ ížˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸°
    
    - name: Install clang-format
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format-14
    
    - name: Run clang-format
      run: |
        # ëª¨ë“  C/C++ íŒŒì¼ í¬ë§·íŒ…
        find . -type f \( -name "*.c" -o -name "*.cpp" -o -name "*.h" -o -name "*.hpp" \) \
          -not -path "./build/*" -not -path "./third_party/*" -not -path "./.git/*" | \
        xargs clang-format-14 -i -style=file
    
    - name: Check for changes
      id: verify-changed-files
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "## ðŸ“ Files formatted:" >> $GITHUB_STEP_SUMMARY
          git status --porcelain | sed 's/^ M /- /' >> $GITHUB_STEP_SUMMARY
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "âœ… All files are already properly formatted!" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Commit and push changes
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add .
        git commit -m "ðŸŽ¨ Auto-format code with clang-format [skip ci]"
        git push origin HEAD:${{ github.ref_name }}
        
        echo "### âœ… Code has been automatically formatted and pushed!" >> $GITHUB_STEP_SUMMARY

  # cppcheck ì •ì  ë¶„ì„
  static-analysis:
    # auto-formatì´ ìžˆìœ¼ë©´ ê·¸ ë‹¤ìŒì— ì‹¤í–‰, ì—†ìœ¼ë©´ ë°”ë¡œ ì‹¤í–‰
    needs: [auto-format]
    if: always() && !cancelled() && !contains(github.event.head_commit.message, '[skip ci]')
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        ref: ${{ github.ref }}
        fetch-depth: 0  # ìµœì‹  ë³€ê²½ì‚¬í•­ í¬í•¨í•´ì„œ ê°€ì ¸ì˜¤ê¸°
    
    - name: Pull latest changes (if any)
      run: |
        git pull origin ${{ github.ref_name }} || true
    
    - name: Install cppcheck
      run: |
        sudo apt-get update
        sudo apt-get install -y cppcheck
    
    - name: Run cppcheck
      run: |
        # cppcheck ì‹¤í–‰ ë° ë¦¬í¬íŠ¸ ìƒì„±
        cppcheck --enable=all \
                 --error-exitcode=0 \
                 --suppress=missingIncludeSystem \
                 --suppress=unmatchedSuppression \
                 --suppress=unusedFunction \
                 --inline-suppr \
                 --xml \
                 --xml-version=2 \
                 --output-file=cppcheck_report.xml \
                 ./src ./include 2>&1 | tee cppcheck_output.txt
        
        # ê²°ê³¼ë¥¼ GitHub Summaryì— ì¶”ê°€
        echo "## ðŸ” Cppcheck Analysis Results" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        if grep -E "\[(error|warning|style|performance|portability)\]" cppcheck_output.txt; then
          grep -E "\[(error|warning|style|performance|portability)\]" cppcheck_output.txt >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… No issues found!" >> $GITHUB_STEP_SUMMARY
        fi
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        
        # ì—ëŸ¬ ì¹´ìš´íŠ¸
        ERROR_COUNT=$(grep -c "\[error\]" cppcheck_output.txt || true)
        WARNING_COUNT=$(grep -c "\[warning\]" cppcheck_output.txt || true)
        STYLE_COUNT=$(grep -c "\[style\]" cppcheck_output.txt || true)
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Summary" >> $GITHUB_STEP_SUMMARY
        echo "- Errors: $ERROR_COUNT" >> $GITHUB_STEP_SUMMARY
        echo "- Warnings: $WARNING_COUNT" >> $GITHUB_STEP_SUMMARY  
        echo "- Style issues: $STYLE_COUNT" >> $GITHUB_STEP_SUMMARY
        
        # ì‹¬ê°í•œ ì—ëŸ¬ê°€ ìžˆìœ¼ë©´ ë¹Œë“œ ì‹¤íŒ¨
        if [ $ERROR_COUNT -gt 0 ]; then
          echo "âŒ Critical errors found! Please fix them."
          exit 1
        fi
    
    - name: Upload cppcheck report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: cppcheck-report
        path: |
          cppcheck_report.xml
          cppcheck_output.txt

  # ë¹Œë“œ ë° ì»´íŒŒì¼
  build:
    needs: [static-analysis]
    if: always() && !cancelled() && !contains(github.event.head_commit.message, '[skip ci]')
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        ref: ${{ github.ref }}
        submodules: recursive
        fetch-depth: 0
    
    - name: Pull latest changes
      run: |
        git pull origin ${{ github.ref_name }} || true
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake ninja-build
        
        # ARM í¬ë¡œìŠ¤ ì»´íŒŒì¼ëŸ¬ (í•„ìš”ì‹œ ì£¼ì„ í•´ì œ)
        # sudo apt-get install -y gcc-arm-none-eabi
    
    - name: Configure CMake
      run: |
        cmake -B build \
              -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
              -DCMAKE_VERBOSE_MAKEFILE=ON \
              -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
              -G Ninja
    
    - name: Build
      run: |
        cmake --build build --config ${{ env.BUILD_TYPE }}
        echo "## âœ… Build Successful!" >> $GITHUB_STEP_SUMMARY
    
    - name: Display binary info
      run: |
        echo "## ðŸ“Š Binary Information" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        
        # ì‹¤í–‰ íŒŒì¼ì´ë‚˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì°¾ê¸°
        find build -type f \( -name "*.elf" -o -name "*.out" -o -name "*.exe" -o -name "*.a" -o -name "*.so" \) ! -path "*/CMakeFiles/*" | while read file; do
          echo "ðŸ“ $(basename $file)" >> $GITHUB_STEP_SUMMARY
          size "$file" 2>/dev/null | tail -n +2 >> $GITHUB_STEP_SUMMARY || true
          echo "" >> $GITHUB_STEP_SUMMARY
        done
        
        # .hex, .bin íŒŒì¼ ì •ë³´
        find build -type f \( -name "*.hex" -o -name "*.bin" \) | while read file; do
          echo "ðŸ“ $(basename $file): $(stat -c%s $file) bytes" >> $GITHUB_STEP_SUMMARY
        done
        
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: build-artifacts-${{ github.sha }}
        path: |
          build/**/*.hex
          build/**/*.bin
          build/**/*.elf
          build/**/*.map
          build/compile_commands.json

  # ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
  test:
    needs: [build]
    if: always() && !cancelled() && !contains(github.event.head_commit.message, '[skip ci]')
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        ref: ${{ github.ref }}
        fetch-depth: 0
    
    - name: Pull latest changes
      run: |
        git pull origin ${{ github.ref_name }} || true
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake valgrind
    
    - name: Build tests
      run: |
        cmake -B build -DBUILD_TESTS=ON -DCMAKE_BUILD_TYPE=Debug
        cmake --build build
    
    - name: Run tests
      continue-on-error: true
      run: |
        cd build
        echo "## ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
        
        # CTest ì‹¤í–‰
        if command -v ctest &> /dev/null && [ -f "CTestTestfile.cmake" ]; then
          ctest --output-on-failure --verbose 2>&1 | tee test_results.txt
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          tail -20 test_results.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        # ë˜ëŠ” test ì‹¤í–‰íŒŒì¼ ì§ì ‘ ì‹¤í–‰
        elif [ -f "./test" ] || [ -f "./tests" ] || [ -f "./run_tests" ]; then
          for test_exe in test tests run_tests; do
            if [ -f "./$test_exe" ]; then
              echo "Running $test_exe..." >> $GITHUB_STEP_SUMMARY
              ./$test_exe 2>&1 | tee test_results.txt
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              cat test_results.txt >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              break
            fi
          done
        else
          echo "âš ï¸ No tests found. Consider adding unit tests!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Add `BUILD_TESTS` option to your CMakeLists.txt:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`cmake" >> $GITHUB_STEP_SUMMARY
          echo "option(BUILD_TESTS \"Build unit tests\" OFF)" >> $GITHUB_STEP_SUMMARY
          echo "if(BUILD_TESTS)" >> $GITHUB_STEP_SUMMARY
          echo "    add_subdirectory(tests)" >> $GITHUB_STEP_SUMMARY
          echo "endif()" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Memory check with Valgrind
      if: success() || failure()
      continue-on-error: true
      run: |
        cd build
        echo "## ðŸ”¬ Memory Check (Valgrind)" >> $GITHUB_STEP_SUMMARY
        
        # í…ŒìŠ¤íŠ¸ ì‹¤í–‰íŒŒì¼ ì°¾ê¸°
        TEST_EXE=""
        for exe in test tests run_tests; do
          if [ -f "./$exe" ]; then
            TEST_EXE="./$exe"
            break
          fi
        done
        
        if [ -n "$TEST_EXE" ]; then
          valgrind --leak-check=full \
                   --show-leak-kinds=all \
                   --track-origins=yes \
                   --verbose \
                   $TEST_EXE 2>&1 | tee valgrind.log
          
          # ê²°ê³¼ ìš”ì•½
          if grep -q "ERROR SUMMARY: 0 errors" valgrind.log; then
            echo "âœ… **No memory leaks detected!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Memory issues detected:**" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            grep -A 5 "LEAK SUMMARY" valgrind.log >> $GITHUB_STEP_SUMMARY || true
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "âš ï¸ No test executable found for memory check" >> $GITHUB_STEP_SUMMARY
        fi

  # ì„±ê³µ ì•Œë¦¼ (ì„ íƒì‚¬í•­)
  notify-success:
    needs: [static-analysis, build, test]
    if: success()
    runs-on: ubuntu-latest
    steps:
    - name: Create success summary
      run: |
        echo "# ðŸŽ‰ CI Pipeline Successful!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "All checks passed! âœ…" >> $GITHUB_STEP_SUMMARY

  # ë¦´ë¦¬ì¦ˆ (íƒœê·¸ í‘¸ì‹œ ì‹œ)
  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [static-analysis, build, test]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake
    
    - name: Build release binaries
      run: |
        # Release ë¹Œë“œ
        cmake -B build-release -DCMAKE_BUILD_TYPE=Release
        cmake --build build-release
        
        # Debug ë¹Œë“œ (ë””ë²„ê¹…ìš©)
        cmake -B build-debug -DCMAKE_BUILD_TYPE=Debug
        cmake --build build-debug
        
        # ë°”ì´ë„ˆë¦¬ ìˆ˜ì§‘
        mkdir -p release-files
        
        # ëª¨ë“  ë°”ì´ë„ˆë¦¬ íŒŒì¼ ë³µì‚¬
        find build-release -type f \( -name "*.hex" -o -name "*.bin" -o -name "*.elf" \) -exec cp {} release-files/ \;
        find build-debug -type f \( -name "*.elf" \) | while read file; do
          cp "$file" "release-files/$(basename $file .elf)-debug.elf"
        done
        
        # ë²„ì „ ì •ë³´ íŒŒì¼ ìƒì„±
        cat > release-files/version.txt << EOF
        Release Version: ${{ github.ref_name }}
        Build Date: $(date)
        Git Commit: ${{ github.sha }}
        Compiler: $(gcc --version | head -n1)
        EOF
        
        # README ìƒì„±
        cat > release-files/README.md << EOF
        # Release ${{ github.ref_name }}
        
        ## Files
        - *.hex : Intel HEX format for flashing
        - *.bin : Binary format for direct writing
        - *.elf : ELF format with symbols
        - *-debug.elf : Debug version with full debug symbols
        
        ## Flashing
        \`\`\`bash
        # For STM32
        st-flash write firmware.bin 0x8000000
        
        # For AVR
        avrdude -p atmega328p -c arduino -P /dev/ttyUSB0 -b 115200 -U flash:w:firmware.hex
        \`\`\`
        EOF
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: release-files/*
        generate_release_notes: true
        draft: false
        prerelease: false
